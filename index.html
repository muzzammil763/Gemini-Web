<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gemini + Veo Playground (One‚ÄëPage)</title>
  <style>
    :root{
      --bg-primary: #0a0e13;
      --bg-secondary: #0f1419;
      --card-bg: #151b23;
      --card-elevated: #1a2129;
      --border-subtle: #1e252d;
      --border-medium: #2a3441;
      --text-primary: #e6edf3;
      --text-secondary: #8b9db1;
      --text-muted: #6e7681;
      --accent-primary: #2ea043;
      --accent-secondary: #0969da;
      --accent-tertiary: #8b5cf6;
      --success: #238636;
      --warning: #fb8500;
      --error: #da3633;
      --glass: rgba(21, 27, 35, 0.8);
    }
    
    * { box-sizing: border-box; }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: radial-gradient(ellipse at top, var(--bg-secondary) 0%, var(--bg-primary) 100%);
      color: var(--text-primary);
      font: 14px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
      overflow-x: hidden;
    }
    
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      min-height: 100vh;
    }
    
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.32), inset 0 1px 0 rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(16px);
      margin-bottom: 20px;
    }
    
    .card.elevated {
      background: var(--card-elevated);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }
    
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .pad {
      padding: 20px;
    }
    
    .pad-sm { padding: 12px; }
    .pad-lg { padding: 24px; }
    
    .muted { color: var(--text-muted); }
    .secondary { color: var(--text-secondary); }
    
    .btn {
      background: var(--card-elevated);
      border: 1px solid var(--border-medium);
      color: var(--text-primary);
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }
    
    .btn:hover {
      background: var(--card-bg);
      border-color: var(--accent-secondary);
      transform: translateY(-1px);
    }
    
    .btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn.primary {
      background: linear-gradient(135deg, var(--accent-secondary), var(--accent-tertiary));
      border-color: var(--accent-secondary);
      color: white;
    }
    
    .btn.primary:hover {
      background: linear-gradient(135deg, #0550ae, #7c3aed);
      box-shadow: 0 4px 12px rgba(9, 105, 218, 0.3);
    }
    
    .btn.success {
      background: var(--accent-primary);
      border-color: var(--success);
      color: white;
    }
    
    .btn.danger {
      background: var(--error);
      border-color: #b91c1c;
      color: white;
    }
    
    input, select, textarea {
      background: var(--bg-secondary);
      border: 1px solid var(--border-medium);
      border-radius: 10px;
      color: var(--text-primary);
      padding: 12px 14px;
      outline: none;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent-secondary);
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }
    
    label {
      font-weight: 500;
      color: var(--text-secondary);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .tabs {
      display: flex;
      gap: 4px;
      border-bottom: 1px solid var(--border-subtle);
      padding: 16px 20px 0;
      margin-bottom: 0;
    }
    
    .tab {
      padding: 12px 20px;
      border: 1px solid transparent;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .tab:hover {
      background: var(--card-elevated);
      color: var(--accent-secondary);
    }
    
    .tab.active {
      background: var(--card-elevated);
      border-color: var(--border-medium);
      border-bottom-color: var(--card-elevated);
      color: var(--accent-secondary);
    }
    
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent-secondary);
      border-radius: 2px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      
      .wrap {
        padding: 12px;
      }
      
      .chat-container {
        height: calc(100vh - 150px);
        min-height: 400px;
      }
      
      .row {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .model-selector {
        flex: 1;
        min-width: 200px;
      }
      
      .footer {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .footer .row {
        justify-content: space-between;
      }
      
      .chat-input-container {
        padding: 12px;
      }
      
      #chatInput {
        min-height: 80px;
      }
    }
    
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px);
      min-height: 500px;
    }
    
    .chatlog {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      margin-bottom: 16px;
    }
    
    .chat-input-container {
      position: sticky;
      bottom: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border-subtle);
      padding: 16px;
      border-radius: 0 0 16px 16px;
      z-index: 100;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
    }
    
    .chat-input-container::before {
      content: '';
      position: absolute;
      top: -10px;
      left: 0;
      right: 0;
      height: 10px;
      background: linear-gradient(to bottom, transparent, var(--card-bg));
      pointer-events: none;
    }
    
    .chatlog::-webkit-scrollbar {
      width: 6px;
    }
    
    .chatlog::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chatlog::-webkit-scrollbar-thumb {
      background: var(--border-medium);
      border-radius: 3px;
    }
    
    .bubble {
      padding: 12px 16px;
      border-radius: 16px;
      max-width: 85%;
      word-wrap: break-word;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .user {
      background: linear-gradient(135deg, var(--accent-secondary), var(--accent-tertiary));
      align-self: flex-end;
      color: white;
      margin-left: auto;
    }
    
    .bot {
      background: var(--card-elevated);
      align-self: flex-start;
      border: 1px solid var(--border-subtle);
      margin-right: auto;
    }
    
    .meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    .pill {
      display: inline-flex;
      align-items: center;
      border: 1px solid var(--border-medium);
      border-radius: 20px;
      padding: 4px 10px;
      margin-right: 8px;
      font-size: 12px;
      background: var(--card-elevated);
      color: var(--text-secondary);
      gap: 4px;
    }
    
    .pill.status {
      background: var(--accent-primary);
      border-color: var(--success);
      color: white;
    }
    
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    
    video, img {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
    }
    
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .small { font-size: 12px; }
    .right { margin-left: auto; }
    
    .kbd {
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background: var(--bg-secondary);
      border: 1px solid var(--border-medium);
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 11px;
    }
    
    .tag {
      font-size: 11px;
      color: var(--text-secondary);
      border: 1px solid var(--border-medium);
      border-radius: 12px;
      padding: 2px 8px;
      margin-left: 6px;
      background: var(--card-bg);
    }
    
    .progress {
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border-subtle);
    }
    
    .progress > span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .model-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--card-elevated);
      border: 1px solid var(--border-medium);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .model-selector:hover {
      border-color: var(--accent-secondary);
    }
    
    .model-info {
      flex: 1;
    }
    
    .model-name {
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .model-desc {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: var(--card-elevated);
      color: var(--text-primary);
      text-align: center;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid var(--border-medium);
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    .settings-group {
      background: var(--card-bg);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
    }
    
    .settings-group h3 {
      margin: 0 0 12px 0;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
    }
    
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .setting-row:last-child {
      margin-bottom: 0;
    }
    
    .setting-label {
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .setting-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    .setting-control {
      min-width: 100px;
    }
    
    .header-title {
      background: linear-gradient(135deg, var(--accent-secondary), var(--accent-tertiary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 8px 0;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card elevated pad stack">
    <h2 class="header-title">üöÄ Gemini AI Playground</h2>
    <div class="secondary small">‚ö†Ô∏è Client-side prototype ¬∑ Keep your API keys secure</div>
    <div class="grid">
      <div class="stack">
        <label>Paste your Gemini API Key</label>
        <div class="row">
          <input id="apiKey" type="password" placeholder="AI Studio key (starts with AI...)" style="flex:1" />
          <button id="connectBtn" class="btn primary">Connect</button>
          <button id="clearKeyBtn" class="btn danger" title="Forget key">Forget</button>
        </div>
        <label class="small"><input type="checkbox" id="rememberKey"/> Remember locally (localStorage)</label>
        <div id="keyStatus" class="muted small">Not connected</div>
      </div>
      <div class="stack">
        <label>History storage</label>
        <div class="row">
          <button class="btn" id="exportHistory">Export JSON</button>
          <input type="file" id="importHistory" accept="application/json"/>
          <button class="btn" id="clearHistory">Clear History</button>
        </div>
        <div class="muted small">Chat + generations are saved to your browser if enabled.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="tabs">
      <div class="tab active" data-tab="chat">Chat</div>
      <div class="tab" data-tab="image">Image Gen</div>
      <div class="tab" data-tab="video">Video (Veo)</div>
      <div class="tab" data-tab="settings">Settings</div>
    </div>
    <div class="pad" id="panel-chat">
      <div class="row" style="margin-bottom: 16px;">
        <div class="model-selector" id="quickModelSelector">
          <div class="model-info">
            <div class="model-name" id="currentModelName">Gemini 2.5 Flash</div>
            <div class="model-desc" id="currentModelDesc">Fast & efficient for most tasks</div>
          </div>
          <span style="color: var(--text-muted);">‚ñº</span>
        </div>
        <div class="pill status" id="connectionStatus">
          <span>‚óè</span> <span id="statusText">Not Connected</span>
        </div>
      </div>
      
      <div class="chat-container">
        <div class="chatlog" id="chatlog">
          <div class="muted small" style="text-align: center; padding: 20px;">
            Connect your API key and start chatting with Gemini AI models
          </div>
        </div>
        
        <div class="chat-input-container">
      <div class="stack">
            <textarea id="chatInput" placeholder="Type your message‚Ä¶ (Shift+Enter for new line, Enter to send)" style="min-height: 60px;"></textarea>
        <div class="footer">
              <div class="row" style="gap: 8px;">
                <span class="pill">
                  <span>‚ö°</span> <span id="chatLatency">‚Äì</span>
                </span>
                <span class="pill">
                  <span>üî¢</span> <span id="chatTokens">‚Äì</span>
                </span>
                <span class="pill">
                  <span>üß†</span> <span id="thinkingStatus">Normal</span>
                </span>
          </div>
          <div class="row">
                <label class="small tooltip">
                  <input type="checkbox" id="persistChat" checked/> Save to history
                  <span class="tooltiptext">Save conversations to browser localStorage</span>
                </label>
                <button class="btn primary" id="sendChat" disabled>
                  <span>üí¨</span> Send
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="pad" id="panel-image" style="display:none">
      <div class="stack">
        <div class="grid">
          <div class="stack">
            <label>Prompt</label>
            <textarea id="imgPrompt" placeholder="e.g., A cinematic portrait of a snow leopard wearing neon sunglasses"></textarea>
          </div>
          <div class="stack">
            <label>Mode</label>
            <div class="row">
              <select id="imgModel">
                <option value="gemini-2.0-flash-preview-image-generation">Gemini 2.0 Flash (image gen preview)</option>
                <option value="imagen-4.0-generate-001">Imagen 4 (high quality)</option>
              </select>
              <button class="btn primary" id="genImage">Generate</button>
            </div>
            <div class="small muted">Gemini image gen requires responseModalities TEXT+IMAGE; Imagen returns image bytes directly.</div>
          </div>
        </div>
        <div class="progress" id="imgProgress" hidden><span></span></div>
        <div id="imgLatency" class="small muted">Latency: ‚Äì</div>
        <div class="media-grid" id="imgOut"></div>
      </div>
    </div>

    <div class="pad" id="panel-video" style="display:none">
      <div class="stack">
        <div class="grid">
          <div class="stack">
            <label>Prompt</label>
            <textarea id="vidPrompt" placeholder="e.g., A dramatic aerial shot over mountains at sunrise with soft ambient wind"></textarea>
          </div>
          <div class="stack">
            <label>Veo Model & Options</label>
            <div class="row">
              <select id="veoModel">
                <option value="veo-3.0-generate-preview">Veo 3 (Preview, with audio)</option>
                <option value="veo-3.0-fast-generate-preview">Veo 3 Fast (Preview)</option>
                <option value="veo-2.0-generate-001">Veo 2 (Stable, silent)</option>
              </select>
              <select id="veoAR">
                <option value="16:9">16:9</option>
                <option value="9:16">9:16</option>
              </select>
              <button class="btn primary" id="genVideo">Generate</button>
            </div>
            <div class="small muted">Veo 3 returns ~8s 720p @ 24fps; Veo 2 supports 5‚Äì8s and 16:9 or 9:16.</div>
          </div>
        </div>
        <div class="progress" id="vidProgress" hidden><span></span></div>
        <div id="vidLatency" class="small muted">Latency: ‚Äì</div>
        <div class="media-grid" id="vidOut"></div>
      </div>
    </div>

    <div class="pad" id="panel-settings" style="display:none">
      <div class="stack">
        <div class="settings-group">
          <h3>ü§ñ Model Selection</h3>
          <div class="setting-row">
            <div>
              <div class="setting-label">Chat Model</div>
              <div class="setting-desc">Choose the AI model for conversations</div>
            </div>
            <select id="chatModel" class="setting-control">
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
              <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
              <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental)</option>
              <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
              <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            </select>
          </div>
            </div>

        <div class="settings-group">
          <h3>üß† Advanced Reasoning</h3>
          <div class="setting-row">
            <div>
              <div class="setting-label">Thinking Budget</div>
              <div class="setting-desc">Controls reasoning depth (-1: dynamic, 0: off, 1-100: custom)</div>
          </div>
            <input type="number" id="thinkingBudget" min="-1" max="100" value="0" class="setting-control" style="width:80px" />
        </div>
      </div>

        <div class="settings-group">
          <h3>‚öôÔ∏è Generation Parameters</h3>
          <div class="setting-row">
            <div>
              <div class="setting-label">Temperature</div>
              <div class="setting-desc">Creativity level (0.0 = focused, 1.0 = creative)</div>
            </div>
            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" class="setting-control" />
            <span id="temperatureValue" class="small muted">0.7</span>
          </div>
          
          <div class="setting-row">
            <div>
              <div class="setting-label">Top-P</div>
              <div class="setting-desc">Nucleus sampling (0.1 = focused, 1.0 = diverse)</div>
            </div>
            <input type="range" id="topP" min="0.1" max="1" step="0.1" value="0.8" class="setting-control" />
            <span id="topPValue" class="small muted">0.8</span>
          </div>
          
          <div class="setting-row">
            <div>
              <div class="setting-label">Top-K</div>
              <div class="setting-desc">Token sampling limit (1-40, higher = more diverse)</div>
            </div>
            <input type="range" id="topK" min="1" max="40" step="1" value="20" class="setting-control" />
            <span id="topKValue" class="small muted">20</span>
          </div>
          
          <div class="setting-row">
            <div>
              <div class="setting-label">Max Output Tokens</div>
              <div class="setting-desc">Maximum response length (100-8192)</div>
            </div>
            <input type="number" id="maxTokens" min="100" max="8192" value="2048" class="setting-control" style="width:80px" />
          </div>
        </div>

        <div class="settings-group">
          <h3>üõ°Ô∏è Safety & Content</h3>
          <div class="setting-row">
            <div>
              <div class="setting-label">Safety Level</div>
              <div class="setting-desc">Content filtering strictness</div>
            </div>
            <select id="safetyLevel" class="setting-control">
              <option value="BLOCK_NONE">Off</option>
              <option value="BLOCK_ONLY_HIGH" selected>Block High Risk</option>
              <option value="BLOCK_MEDIUM_AND_ABOVE">Block Medium+</option>
              <option value="BLOCK_LOW_AND_ABOVE">Block Low+</option>
            </select>
          </div>
          
          <div class="setting-row">
            <div>
              <div class="setting-label">System Instructions</div>
              <div class="setting-desc">Custom behavior instructions for the AI</div>
            </div>
          </div>
          <textarea id="systemInstructions" placeholder="Enter custom system instructions..." style="min-height: 60px; margin-top: 8px;"></textarea>
        </div>

        <div class="row" style="margin-top: 20px;">
          <button class="btn" id="resetSettings">Reset to Defaults</button>
          <button class="btn primary" id="saveSettings">Save Settings</button>
        </div>
      </div>
    </div>
  </div>

  <div class="pad muted small">Made with <span class="kbd">@google/genai</span>. Videos include SynthID watermark. This page stores history locally only if you enable it.</div>
</div>

<script type="module">
  // Import SDK (browser ESM)
  import { GoogleGenAI, Modality } from 'https://esm.run/@google/genai';

  // ----- State & helpers -----
  let ai = null;
  let apiKey = '';
  let chatHistory = JSON.parse(localStorage.getItem('gemini_history')||'[]');
  let currentSettings = {
    model: 'gemini-2.5-flash',
    temperature: 0.7,
    topP: 0.8,
    topK: 20,
    maxTokens: 2048,
    thinkingBudget: 0,
    safetyLevel: 'BLOCK_ONLY_HIGH',
    systemInstructions: ''
  };

  // Model information
  const modelInfo = {
    'gemini-2.5-flash': {
      name: 'Gemini 2.5 Flash',
      desc: 'Fast & efficient for most tasks',
      features: ['Text', 'Code', 'Reasoning']
    },
    'gemini-2.5-flash-lite': {
      name: 'Gemini 2.5 Flash Lite',
      desc: 'Lightweight version, optimized for speed',
      features: ['Text', 'Code']
    },
    'gemini-2.5-pro': {
      name: 'Gemini 2.5 Pro',
      desc: 'Most capable model for complex tasks',
      features: ['Text', 'Code', 'Advanced Reasoning', 'Long Context']
    },
    'gemini-2.0-flash-exp': {
      name: 'Gemini 2.0 Flash',
      desc: 'Experimental features and latest capabilities',
      features: ['Text', 'Code', 'Multimodal', 'Experimental']
    },
    'gemini-1.5-pro': {
      name: 'Gemini 1.5 Pro',
      desc: 'Stable production model with excellent reasoning',
      features: ['Text', 'Code', 'Long Context']
    },
    'gemini-1.5-flash': {
      name: 'Gemini 1.5 Flash',
      desc: 'Fast model for general use cases',
      features: ['Text', 'Code']
    }
  };

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  
  const setLatency = (el, ms) => el.textContent = `${ms.toFixed(0)}ms`;
  const setTokens = (el, usage) => {
    if (!usage) { el.textContent = 'n/a'; return; }
    const p = usage.promptTokenCount ?? usage.inputTokenCount;
    const c = usage.candidatesTokenCount ?? usage.outputTokenCount;
    el.textContent = `${p||0}/${c||0}`;
  };
  
  const saveHistory = () => localStorage.setItem('gemini_history', JSON.stringify(chatHistory));
  const saveSettings = () => localStorage.setItem('gemini_settings', JSON.stringify(currentSettings));
  const loadSettings = () => {
    const saved = localStorage.getItem('gemini_settings');
    if (saved) {
      currentSettings = { ...currentSettings, ...JSON.parse(saved) };
      updateSettingsUI();
    }
  };
  
  const addToHistory = (type, payload) => {
    const item = { id: crypto.randomUUID(), t: Date.now(), type, payload };
    chatHistory.push(item);
    if ($('#persistChat').checked) saveHistory();
    return item;
  };
  
  const asBlob = async (base64, mime) => fetch(`data:${mime};base64,${base64}`).then(r=>r.blob());
  
  const updateConnectionStatus = (connected) => {
    const status = $('#connectionStatus');
    const statusText = $('#statusText');
    const sendBtn = $('#sendChat');
    
    if (connected) {
      status.className = 'pill status';
      statusText.textContent = 'Connected';
      sendBtn.disabled = false;
    } else {
      status.className = 'pill';
      statusText.textContent = 'Not Connected';
      sendBtn.disabled = true;
    }
  };
  
  const updateModelDisplay = () => {
    const info = modelInfo[currentSettings.model];
    $('#currentModelName').textContent = info.name;
    $('#currentModelDesc').textContent = info.desc;
    $('#chatModel').value = currentSettings.model;
  };
  
  const updateSettingsUI = () => {
    $('#chatModel').value = currentSettings.model;
    $('#temperature').value = currentSettings.temperature;
    $('#temperatureValue').textContent = currentSettings.temperature;
    $('#topP').value = currentSettings.topP;
    $('#topPValue').textContent = currentSettings.topP;
    $('#topK').value = currentSettings.topK;
    $('#topKValue').textContent = currentSettings.topK;
    $('#maxTokens').value = currentSettings.maxTokens;
    $('#thinkingBudget').value = currentSettings.thinkingBudget;
    $('#safetyLevel').value = currentSettings.safetyLevel;
    $('#systemInstructions').value = currentSettings.systemInstructions;
    
    updateModelDisplay();
    updateThinkingStatus();
  };
  
  const updateThinkingStatus = () => {
    const budget = currentSettings.thinkingBudget;
    const status = $('#thinkingStatus');
    if (budget === -1) status.textContent = 'Dynamic';
    else if (budget === 0) status.textContent = 'Normal';
    else status.textContent = `Deep (${budget})`;
  };

  // ----- Tabs -----
  $$('.tab').forEach(tab => tab.addEventListener('click', () => {
    $$('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const id = tab.dataset.tab;
    ['chat','image','video','settings'].forEach(p => {
      const el = document.getElementById(`panel-${p}`);
      el.style.display = (p===id)?'block':'none';
    });
  }));

  // ----- Key connect -----
  const connect = () => {
    apiKey = $('#apiKey').value.trim();
    if (!apiKey) return alert('Please paste your Gemini API key');
    
    try {
      ai = new GoogleGenAI(apiKey);
    $('#keyStatus').textContent = 'Connected';
      updateConnectionStatus(true);
    if ($('#rememberKey').checked) localStorage.setItem('gemini_key', apiKey);
      
      // Clear the welcome message from chatlog
      const chatlog = $('#chatlog');
      if (chatlog.children.length === 1 && chatlog.children[0].textContent.includes('Connect your API key')) {
        chatlog.innerHTML = '';
      }
    } catch (error) {
      alert('Failed to connect: ' + error.message);
      updateConnectionStatus(false);
    }
  };
  
  $('#connectBtn').onclick = connect;
  $('#clearKeyBtn').onclick = () => { 
    localStorage.removeItem('gemini_key'); 
    $('#apiKey').value=''; 
    $('#keyStatus').textContent='Not connected'; 
    updateConnectionStatus(false);
    ai=null; 
  };
  
  // preload saved key only if user opted in earlier
  const saved = localStorage.getItem('gemini_key');
  if (saved) { 
    $('#apiKey').value = saved; 
    $('#rememberKey').checked = true;
    // Auto-connect if key is saved
    setTimeout(connect, 100);
  }
  
  // ----- Settings Event Handlers -----
  $('#quickModelSelector').onclick = () => {
    // Switch to settings tab and focus on model selection
    $$('.tab').forEach(t=>t.classList.remove('active'));
    $$('.tab')[3].classList.add('active'); // Settings tab
    ['chat','image','video','settings'].forEach(p => {
      const el = document.getElementById(`panel-${p}`);
      el.style.display = (p==='settings')?'block':'none';
    });
    $('#chatModel').focus();
  };
  
  // Model selection change
  $('#chatModel').addEventListener('change', (e) => {
    currentSettings.model = e.target.value;
    updateModelDisplay();
    saveSettings();
  });
  
  // Range input updates
  $('#temperature').addEventListener('input', (e) => {
    currentSettings.temperature = parseFloat(e.target.value);
    $('#temperatureValue').textContent = currentSettings.temperature;
    saveSettings();
  });
  
  $('#topP').addEventListener('input', (e) => {
    currentSettings.topP = parseFloat(e.target.value);
    $('#topPValue').textContent = currentSettings.topP;
    saveSettings();
  });
  
  $('#topK').addEventListener('input', (e) => {
    currentSettings.topK = parseInt(e.target.value);
    $('#topKValue').textContent = currentSettings.topK;
    saveSettings();
  });
  
  // Other settings
  $('#maxTokens').addEventListener('change', (e) => {
    currentSettings.maxTokens = parseInt(e.target.value);
    saveSettings();
  });
  
  $('#thinkingBudget').addEventListener('change', (e) => {
    currentSettings.thinkingBudget = parseInt(e.target.value);
    updateThinkingStatus();
    saveSettings();
  });
  
  $('#safetyLevel').addEventListener('change', (e) => {
    currentSettings.safetyLevel = e.target.value;
    saveSettings();
  });
  
  $('#systemInstructions').addEventListener('change', (e) => {
    currentSettings.systemInstructions = e.target.value;
    saveSettings();
  });
  
  // Settings buttons
  $('#resetSettings').onclick = () => {
    if (confirm('Reset all settings to defaults?')) {
      currentSettings = {
        model: 'gemini-2.5-flash',
        temperature: 0.7,
        topP: 0.8,
        topK: 20,
        maxTokens: 2048,
        thinkingBudget: 0,
        safetyLevel: 'BLOCK_ONLY_HIGH',
        systemInstructions: ''
      };
      updateSettingsUI();
      saveSettings();
    }
  };
  
  $('#saveSettings').onclick = () => {
    saveSettings();
    alert('Settings saved successfully!');
  };

  // ----- History import/export -----
  $('#exportHistory').onclick = () => {
    const data = new Blob([JSON.stringify(chatHistory, null, 2)], {type:'application/json'});
    const a = Object.assign(document.createElement('a'), {href: URL.createObjectURL(data), download: 'gemini_history.json'});
    a.click(); URL.revokeObjectURL(a.href);
  };
  $('#importHistory').addEventListener('change', async (e) => {
    const file = e.target.files?.[0]; if (!file) return;
    const text = await file.text();
    try { chatHistory = JSON.parse(text); saveHistory(); renderChatlog(); alert('History imported'); }
    catch { alert('Invalid JSON'); }
  });
  $('#clearHistory').onclick = () => { if (confirm('Clear local history?')) { chatHistory=[]; saveHistory(); renderChatlog(); }};

  // ----- Chat UI -----
  function pushBubble(role, text){
    const div = document.createElement('div');
    div.className = `bubble ${role==='user'?'user':'bot'}`;
    div.innerHTML = text.replace(/\n/g,'<br/>');
    $('#chatlog').appendChild(div); 
    scrollChatToBottom();
  }
  function renderChatlog(){
    $('#chatlog').innerHTML = '';
    chatHistory.filter(h=>h.type==='chat').forEach(({payload})=>{
      pushBubble('user', payload.user);
      pushBubble('model', payload.model);
    });
  }
  renderChatlog();

  async function sendChat(){
    try{
      if (!ai) return alert('Connect your API key first');
      
      const text = $('#chatInput').value.trim();
      if (!text) return;
      
      $('#chatInput').value='';
      $('#sendChat').disabled = true;
      pushBubble('user', text);
      
      const t0 = performance.now();

      // Build generation config with current settings
      const generationConfig = {
        temperature: currentSettings.temperature,
        topP: currentSettings.topP,
        topK: currentSettings.topK,
        maxOutputTokens: currentSettings.maxTokens
      };

      // Build safety settings
      const safetySettings = [{
        category: 'HARM_CATEGORY_HARASSMENT',
        threshold: currentSettings.safetyLevel
      }, {
        category: 'HARM_CATEGORY_HATE_SPEECH',
        threshold: currentSettings.safetyLevel
      }, {
        category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT',
        threshold: currentSettings.safetyLevel
      }, {
        category: 'HARM_CATEGORY_DANGEROUS_CONTENT',
        threshold: currentSettings.safetyLevel
      }];

      // Build contents array
      let contents = [{ role: 'user', parts: [{ text }] }];
      
      // Add system instruction if provided
      let systemInstruction = undefined;
      if (currentSettings.systemInstructions.trim()) {
        systemInstruction = currentSettings.systemInstructions.trim();
      }

      // Get the model
      const model = ai.getGenerativeModel({ 
        model: currentSettings.model,
        generationConfig,
        safetySettings,
        systemInstruction
      });

      // Stream for responsiveness
      const stream = await model.generateContentStream({
        contents,
        ...(currentSettings.thinkingBudget !== 0 && { 
          generationConfig: { 
            ...generationConfig,
            thinkingBudget: currentSettings.thinkingBudget 
          }
        })
      });

      let acc = '';
      for await (const chunk of stream) {
        const delta = chunk.text();
        if (delta) {
          acc += delta;
          // live render last bubble
          if (!$('#chatlog').querySelector('.bubble.bot.live')){
            const div = document.createElement('div');
            div.className = 'bubble bot live';
            $('#chatlog').appendChild(div);
          }
          $('#chatlog').querySelector('.bubble.bot.live').innerHTML = acc.replace(/\n/g,'<br/>');
          scrollChatToBottom();
        }
      }
      
      const resp = await stream.response;
      const t1 = performance.now();
      
      setLatency($('#chatLatency'), t1 - t0);
      setTokens($('#chatTokens'), resp.usageMetadata);
      
      const finalText = resp.text() || acc || '[no text]';
      const live = $('#chatlog').querySelector('.bubble.bot.live');
      if (live) { 
        live.classList.remove('live'); 
        live.innerHTML = finalText.replace(/\n/g,'<br/>'); 
      }
      
      addToHistory('chat', { 
        user: text, 
        model: finalText, 
        usage: resp.usageMetadata, 
        modelId: currentSettings.model,
        settings: { ...currentSettings }
      });
      
    } catch (e){
      console.error(e); 
      
      // Remove any live bubble on error
      const live = $('#chatlog').querySelector('.bubble.bot.live');
      if (live) live.remove();
      
      // Show error in chat
      const errorDiv = document.createElement('div');
      errorDiv.className = 'bubble bot';
      errorDiv.style.background = 'var(--error)';
      errorDiv.style.color = 'white';
      errorDiv.innerHTML = `‚ùå Error: ${e?.message || e}`;
      $('#chatlog').appendChild(errorDiv);
      scrollChatToBottom();
      
    } finally {
      $('#sendChat').disabled = false;
      // Refocus input for next message
      setTimeout(focusInput, 100);
    }
  }

  $('#sendChat').onclick = sendChat;
  $('#chatInput').addEventListener('keydown', e=>{
    if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }
  });

  // ----- Image Generation -----
  $('#genImage').onclick = async () => {
    try{
      if (!ai) return alert('Connect your API key first');
      const model = $('#imgModel').value;
      const prompt = $('#imgPrompt').value.trim();
      if (!prompt) return;
      $('#imgOut').innerHTML = '';
      $('#imgProgress').hidden = false; $('#imgProgress span').style.width = '10%';
      const t0 = performance.now();

      if (model.startsWith('imagen-')){
        // Imagen 4 via dedicated endpoint
        const res = await ai.models.generateImages({ model, prompt });
        const t1 = performance.now(); setLatency($('#imgLatency'), t1-t0);
        const g = document.createDocumentFragment();
        for (const gimg of res.generatedImages){
          const { imageBytes, mimeType } = gimg.image;
          const url = URL.createObjectURL(await asBlob(btoa(String.fromCharCode(...new Uint8Array(imageBytes))), mimeType||'image/png'));
          const card = document.createElement('div');
          card.innerHTML = `<img src="${url}"/><div class="small footer"><a class="btn" download="imagen.png" href="${url}">Download</a></div>`;
          g.appendChild(card);
        }
        $('#imgOut').appendChild(g);
      } else {
        // Gemini 2.0 Flash (image gen) requires TEXT + IMAGE modalities
        const response = await ai.models.generateContent({
          model,
          contents: prompt,
          config: { responseModalities: [Modality.TEXT, Modality.IMAGE] }
        });
        const t1 = performance.now(); setLatency($('#imgLatency'), t1-t0);
        let found=0;
        for (const part of (response.candidates?.[0]?.content?.parts||[])){
          if (part.inlineData){
            found++;
            const mime = part.inlineData.mimeType||'image/png';
            const data = part.inlineData.data; // base64
            const url = URL.createObjectURL(await asBlob(data, mime));
            const card = document.createElement('div');
            card.innerHTML = `<img src="${url}"/><div class="small footer"><a class="btn" download="gemini-image.png" href="${url}">Download</a></div>`;
            $('#imgOut').appendChild(card);
          }
        }
        if (!found){
          const p = document.createElement('div'); p.className='muted'; p.textContent='No image returned. Try rephrasing to explicitly ask for an image.'; $('#imgOut').appendChild(p);
        }
      }
      $('#imgProgress').hidden = true; $('#imgProgress span').style.width = '0%';
      addToHistory('image', { model, prompt });
    } catch(e){ console.error(e); alert('Image error: '+(e?.message||e)); $('#imgProgress').hidden = true; }
  };

  // ----- Video (Veo) -----
  $('#genVideo').onclick = async () => {
    try{
      if (!ai) return alert('Connect your API key first');
      const model = $('#veoModel').value;
      const prompt = $('#vidPrompt').value.trim();
      if (!prompt) return;
      $('#vidOut').innerHTML = '';
      $('#vidProgress').hidden=false; $('#vidProgress span').style.width='10%';
      const t0 = performance.now();

      let operation = await ai.models.generateVideos({
        model,
        prompt,
        config: { aspectRatio: $('#veoAR').value }
      });

      // Poll until done
      let pct = 15;
      while (!operation.done){
        await new Promise(r=>setTimeout(r, 5000));
        operation = await ai.operations.getVideosOperation({ operation });
        pct = Math.min(95, pct+5); $('#vidProgress span').style.width = pct+'%';
      }

      const t1 = performance.now(); setLatency($('#vidLatency'), t1-t0);
      $('#vidProgress span').style.width = '100%';

      // Try to download: prefer URI if available (browser‚Äëfriendly)
      let fileObj = operation.response?.generatedVideos?.[0]?.video;
      let uri = fileObj?.uri || operation.response?.generateVideoResponse?.generatedSamples?.[0]?.video?.uri;
      let blob;
      if (uri){
        const res = await fetch(uri, { headers: { 'x-goog-api-key': apiKey } });
        blob = await res.blob();
      } else if (fileObj?.videoBytes){
        blob = new Blob([new Uint8Array(fileObj.videoBytes)], { type: fileObj.mimeType||'video/mp4' });
      } else {
        // Fallback using files.download may not work in browser; attempt anyway
        try { const dl = await ai.files.download({ file: fileObj }); blob = new Blob([dl.fileBytes], { type: dl.mimeType||'video/mp4' }); } catch {}
      }

      if (!blob) throw new Error('Could not retrieve video bytes');

      const url = URL.createObjectURL(blob);
      const el = document.createElement('div');
      el.innerHTML = `<video controls src="${url}"></video>
        <div class="footer small"><a class="btn" href="${url}" download="veo.mp4">Download video</a>
        <span class="tag">Model: ${model}</span><span class="tag">AR: ${$('#veoAR').value}</span></div>`;
      $('#vidOut').appendChild(el);

      $('#vidProgress').hidden=true; $('#vidProgress span').style.width='0%';
      addToHistory('video', { model, prompt });
    } catch(e){ console.error(e); alert('Video error: '+(e?.message||e)); $('#vidProgress').hidden=true; }
  };

  // ----- Auto-focus and UX improvements -----
  const focusInput = () => {
    const chatInput = $('#chatInput');
    if (chatInput && !chatInput.disabled) {
      chatInput.focus();
    }
  };
  
  // Focus input when switching to chat tab
  $$('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      if (tab.dataset.tab === 'chat') {
        setTimeout(focusInput, 100);
      }
    });
  });
  
  // Auto-scroll chat to bottom when new messages arrive
  const scrollChatToBottom = () => {
    const chatlog = $('#chatlog');
    chatlog.scrollTop = chatlog.scrollHeight;
  };
  
  // Improved chat input behavior
  $('#chatInput').addEventListener('input', (e) => {
    // Auto-resize textarea
    e.target.style.height = 'auto';
    e.target.style.height = Math.min(e.target.scrollHeight, 200) + 'px';
  });
  
  // Focus input when page loads if on chat tab
  document.addEventListener('DOMContentLoaded', () => {
    if ($$('.tab')[0].classList.contains('active')) {
      setTimeout(focusInput, 500);
    }
  });
  
  // ----- Initialize App -----
  loadSettings();
  updateConnectionStatus(false);
  renderChatlog();
  
  // Focus input after initialization
  setTimeout(focusInput, 100);
</script>
</body>
</html>
