<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gemini + Veo Playground (One‑Page)</title>
  <style>
    :root{--bg:#0b0f14;--card:#121821;--muted:#8aa0b2;--text:#e9f1f7;--accent:#59d0ff;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0b0f14 60%,#0e1520);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu}
    .wrap{max-width:1100px;margin:20px auto;padding:16px}
    .card{background:var(--card);border:1px solid #1c2733;border-radius:16px;box-shadow:0 6px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;align-items:center}
    .stack{display:flex;flex-direction:column;gap:10px}
    .pad{padding:14px}
    .muted{color:var(--muted)}
    .btn{background:#162232;border:1px solid #223041;color:#eaf6ff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.primary{background:linear-gradient(180deg,#1b86a8,#176b86);border-color:#1e8fb3}
    .btn.danger{background:#3a1216;border-color:#5c1a20}
    input, select, textarea{background:#0f1520;border:1px solid #28394c;border-radius:12px;color:var(--text);padding:10px 12px;outline:none}
    textarea{min-height:90px}
    .tabs{display:flex;gap:8px;border-bottom:1px solid #1a2632;padding:8px}
    .tab{padding:8px 12px;border:1px solid transparent;border-radius:10px;cursor:pointer}
    .tab.active{background:#122034;border-color:#1e3143}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .chatlog{height:380px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .bubble{padding:10px 12px;border-radius:14px;max-width:80%}
    .user{background:#163147;align-self:flex-end}
    .bot{background:#1a2433;align-self:flex-start}
    .meta{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;border:1px solid #2b3b4f;border-radius:999px;padding:2px 8px;margin-right:6px}
    .media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    video, img{width:100%;border-radius:12px;border:1px solid #243243}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .small{font-size:12px}
    .right{float:right}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace;background:#0b111a;border:1px solid #223146;border-radius:8px;padding:2px 6px}
    .tag{font-size:11px;color:#a6c4d8;border:1px solid #2a3a4e;border-radius:999px;padding:2px 6px;margin-left:6px}
    .progress{height:6px;background:#0e1621;border-radius:8px;overflow:hidden}
    .progress > span{display:block;height:100%;background:linear-gradient(90deg,#1593b4,#26b1d1);width:0%}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card pad stack">
    <h2 style="margin:4px 0">Gemini + Veo Playground</h2>
    <div class="muted small">⚠️ Prototype for client‑side use. Don’t expose real/production keys in the browser.</div>
    <div class="grid">
      <div class="stack">
        <label>Paste your Gemini API Key</label>
        <div class="row">
          <input id="apiKey" type="password" placeholder="AI Studio key (starts with AI...)" style="flex:1" />
          <button id="connectBtn" class="btn primary">Connect</button>
          <button id="clearKeyBtn" class="btn danger" title="Forget key">Forget</button>
        </div>
        <label class="small"><input type="checkbox" id="rememberKey"/> Remember locally (localStorage)</label>
        <div id="keyStatus" class="muted small">Not connected</div>
      </div>
      <div class="stack">
        <label>History storage</label>
        <div class="row">
          <button class="btn" id="exportHistory">Export JSON</button>
          <input type="file" id="importHistory" accept="application/json"/>
          <button class="btn" id="clearHistory">Clear History</button>
        </div>
        <div class="muted small">Chat + generations are saved to your browser if enabled.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="tabs">
      <div class="tab active" data-tab="chat">Chat</div>
      <div class="tab" data-tab="image">Image Gen</div>
      <div class="tab" data-tab="video">Video (Veo)</div>
      <div class="tab" data-tab="settings">Settings</div>
    </div>
    <div class="pad" id="panel-chat">
      <div class="chatlog" id="chatlog"></div>
      <div class="stack">
        <textarea id="chatInput" placeholder="Type your message… (Shift+Enter = newline)"></textarea>
        <div class="footer">
          <div>
            <span class="pill">Model: <span id="chatModelLbl">gemini-2.5-flash</span></span>
            <span class="pill">Latency: <span id="chatLatency">–</span></span>
            <span class="pill">Tokens: <span id="chatTokens">–</span></span>
          </div>
          <div class="row">
            <label class="small"><input type="checkbox" id="persistChat" checked/> Save to history</label>
            <button class="btn primary" id="sendChat">Send</button>
          </div>
        </div>
      </div>
    </div>

    <div class="pad" id="panel-image" style="display:none">
      <div class="stack">
        <div class="grid">
          <div class="stack">
            <label>Prompt</label>
            <textarea id="imgPrompt" placeholder="e.g., A cinematic portrait of a snow leopard wearing neon sunglasses"></textarea>
          </div>
          <div class="stack">
            <label>Mode</label>
            <div class="row">
              <select id="imgModel">
                <option value="gemini-2.0-flash-preview-image-generation">Gemini 2.0 Flash (image gen preview)</option>
                <option value="imagen-4.0-generate-001">Imagen 4 (high quality)</option>
              </select>
              <button class="btn primary" id="genImage">Generate</button>
            </div>
            <div class="small muted">Gemini image gen requires responseModalities TEXT+IMAGE; Imagen returns image bytes directly.</div>
          </div>
        </div>
        <div class="progress" id="imgProgress" hidden><span></span></div>
        <div id="imgLatency" class="small muted">Latency: –</div>
        <div class="media-grid" id="imgOut"></div>
      </div>
    </div>

    <div class="pad" id="panel-video" style="display:none">
      <div class="stack">
        <div class="grid">
          <div class="stack">
            <label>Prompt</label>
            <textarea id="vidPrompt" placeholder="e.g., A dramatic aerial shot over mountains at sunrise with soft ambient wind"></textarea>
          </div>
          <div class="stack">
            <label>Veo Model & Options</label>
            <div class="row">
              <select id="veoModel">
                <option value="veo-3.0-generate-preview">Veo 3 (Preview, with audio)</option>
                <option value="veo-3.0-fast-generate-preview">Veo 3 Fast (Preview)</option>
                <option value="veo-2.0-generate-001">Veo 2 (Stable, silent)</option>
              </select>
              <select id="veoAR">
                <option value="16:9">16:9</option>
                <option value="9:16">9:16</option>
              </select>
              <button class="btn primary" id="genVideo">Generate</button>
            </div>
            <div class="small muted">Veo 3 returns ~8s 720p @ 24fps; Veo 2 supports 5–8s and 16:9 or 9:16.</div>
          </div>
        </div>
        <div class="progress" id="vidProgress" hidden><span></span></div>
        <div id="vidLatency" class="small muted">Latency: –</div>
        <div class="media-grid" id="vidOut"></div>
      </div>
    </div>

    <div class="pad" id="panel-settings" style="display:none">
      <div class="stack">
        <div class="grid">
          <div class="stack">
            <label>Chat Model</label>
            <select id="chatModel">
              <option>gemini-2.5-flash</option>
              <option>gemini-2.5-flash-lite</option>
              <option>gemini-2.5-pro</option>
            </select>
          </div>
          <div class="stack">
            <label>Thinking (advanced)</label>
            <div class="row">
              <input type="number" id="thinkingBudget" min="-1" value="0" style="width:120px" />
              <span class="muted small">-1 dynamic, 0 off, higher = deeper reasoning</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="pad muted small">Made with <span class="kbd">@google/genai</span>. Videos include SynthID watermark. This page stores history locally only if you enable it.</div>
</div>

<script type="module">
  // Import SDK (browser ESM)
  import { GoogleGenAI, Modality } from 'https://esm.run/@google/genai';

  // ----- State & helpers -----
  let ai = null;
  let apiKey = '';
  let chatHistory = JSON.parse(localStorage.getItem('gemini_history')||'[]');

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const setLatency = (el, ms) => el.textContent = `${ms.toFixed(0)} ms`;
  const setTokens = (el, usage) => {
    if (!usage) { el.textContent = 'n/a'; return; }
    const p = usage.promptTokenCount ?? usage.inputTokenCount;
    const c = usage.candidatesTokenCount ?? usage.outputTokenCount;
    el.textContent = `in ${p||0} · out ${c||0}`;
  };
  const saveHistory = () => localStorage.setItem('gemini_history', JSON.stringify(chatHistory));
  const addToHistory = (type, payload) => {
    const item = { id: crypto.randomUUID(), t: Date.now(), type, payload };
    chatHistory.push(item);
    if ($('#persistChat').checked) saveHistory();
    return item;
  };
  const asBlob = async (base64, mime) => fetch(`data:${mime};base64,${base64}`).then(r=>r.blob());

  // ----- Tabs -----
  $$('.tab').forEach(tab => tab.addEventListener('click', () => {
    $$('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const id = tab.dataset.tab;
    ['chat','image','video','settings'].forEach(p => {
      const el = document.getElementById(`panel-${p}`);
      el.style.display = (p===id)?'block':'none';
    });
  }));

  // ----- Key connect -----
  const connect = () => {
    apiKey = $('#apiKey').value.trim();
    if (!apiKey) return alert('Please paste your Gemini API key');
    ai = new GoogleGenAI({ apiKey });
    $('#keyStatus').textContent = 'Connected';
    if ($('#rememberKey').checked) localStorage.setItem('gemini_key', apiKey);
  };
  $('#connectBtn').onclick = connect;
  $('#clearKeyBtn').onclick = () => { localStorage.removeItem('gemini_key'); $('#apiKey').value=''; $('#keyStatus').textContent='Not connected'; ai=null; };
  // preload saved key only if user opted in earlier
  const saved = localStorage.getItem('gemini_key');
  if (saved) { $('#apiKey').value = saved; $('#rememberKey').checked = true; }

  // ----- History import/export -----
  $('#exportHistory').onclick = () => {
    const data = new Blob([JSON.stringify(chatHistory, null, 2)], {type:'application/json'});
    const a = Object.assign(document.createElement('a'), {href: URL.createObjectURL(data), download: 'gemini_history.json'});
    a.click(); URL.revokeObjectURL(a.href);
  };
  $('#importHistory').addEventListener('change', async (e) => {
    const file = e.target.files?.[0]; if (!file) return;
    const text = await file.text();
    try { chatHistory = JSON.parse(text); saveHistory(); renderChatlog(); alert('History imported'); }
    catch { alert('Invalid JSON'); }
  });
  $('#clearHistory').onclick = () => { if (confirm('Clear local history?')) { chatHistory=[]; saveHistory(); renderChatlog(); }};

  // ----- Chat UI -----
  function pushBubble(role, text){
    const div = document.createElement('div');
    div.className = `bubble ${role==='user'?'user':'bot'}`;
    div.innerHTML = text.replace(/\n/g,'<br/>');
    $('#chatlog').appendChild(div); $('#chatlog').scrollTop = 1e9;
  }
  function renderChatlog(){
    $('#chatlog').innerHTML = '';
    chatHistory.filter(h=>h.type==='chat').forEach(({payload})=>{
      pushBubble('user', payload.user);
      pushBubble('model', payload.model);
    });
  }
  renderChatlog();

  $('#chatModel').addEventListener('change', e=> $('#chatModelLbl').textContent = e.target.value);

  async function sendChat(){
    try{
      if (!ai) return alert('Connect your API key first');
      const model = $('#chatModel').value;
      const text = $('#chatInput').value.trim();
      if (!text) return;
      $('#chatInput').value='';
      pushBubble('user', text);
      const t0 = performance.now();

      // Stream for responsiveness
      const stream = await ai.models.generateContentStream({
        model,
        contents: text,
        config: { thinkingBudget: Number($('#thinkingBudget').value||0) }
      });

      let acc = '';
      for await (const chunk of stream) {
        const delta = chunk.text();
        if (delta) {
          acc += delta;
          // live render last bubble
          if (!$('#chatlog').querySelector('.bubble.bot.live')){
            const div = document.createElement('div');
            div.className = 'bubble bot live';
            $('#chatlog').appendChild(div);
          }
          $('#chatlog').querySelector('.bubble.bot.live').innerHTML = acc.replace(/\n/g,'<br/>');
          $('#chatlog').scrollTop = 1e9;
        }
      }
      const resp = await stream.response;
      const t1 = performance.now();
      setLatency($('#chatLatency'), t1 - t0);
      setTokens($('#chatTokens'), resp.usageMetadata);
      const finalText = resp.text || acc || '[no text]';
      const live = $('#chatlog').querySelector('.bubble.bot.live');
      if (live) { live.classList.remove('live'); live.innerHTML = finalText.replace(/\n/g,'<br/>'); }
      addToHistory('chat', { user: text, model: finalText, usage: resp.usageMetadata, modelId: model });
    } catch (e){
      console.error(e); alert('Chat error: '+(e?.message||e));
    }
  }

  $('#sendChat').onclick = sendChat;
  $('#chatInput').addEventListener('keydown', e=>{
    if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }
  });

  // ----- Image Generation -----
  $('#genImage').onclick = async () => {
    try{
      if (!ai) return alert('Connect your API key first');
      const model = $('#imgModel').value;
      const prompt = $('#imgPrompt').value.trim();
      if (!prompt) return;
      $('#imgOut').innerHTML = '';
      $('#imgProgress').hidden = false; $('#imgProgress span').style.width = '10%';
      const t0 = performance.now();

      if (model.startsWith('imagen-')){
        // Imagen 4 via dedicated endpoint
        const res = await ai.models.generateImages({ model, prompt });
        const t1 = performance.now(); setLatency($('#imgLatency'), t1-t0);
        const g = document.createDocumentFragment();
        for (const gimg of res.generatedImages){
          const { imageBytes, mimeType } = gimg.image;
          const url = URL.createObjectURL(await asBlob(btoa(String.fromCharCode(...new Uint8Array(imageBytes))), mimeType||'image/png'));
          const card = document.createElement('div');
          card.innerHTML = `<img src="${url}"/><div class="small footer"><a class="btn" download="imagen.png" href="${url}">Download</a></div>`;
          g.appendChild(card);
        }
        $('#imgOut').appendChild(g);
      } else {
        // Gemini 2.0 Flash (image gen) requires TEXT + IMAGE modalities
        const response = await ai.models.generateContent({
          model,
          contents: prompt,
          config: { responseModalities: [Modality.TEXT, Modality.IMAGE] }
        });
        const t1 = performance.now(); setLatency($('#imgLatency'), t1-t0);
        let found=0;
        for (const part of (response.candidates?.[0]?.content?.parts||[])){
          if (part.inlineData){
            found++;
            const mime = part.inlineData.mimeType||'image/png';
            const data = part.inlineData.data; // base64
            const url = URL.createObjectURL(await asBlob(data, mime));
            const card = document.createElement('div');
            card.innerHTML = `<img src="${url}"/><div class="small footer"><a class="btn" download="gemini-image.png" href="${url}">Download</a></div>`;
            $('#imgOut').appendChild(card);
          }
        }
        if (!found){
          const p = document.createElement('div'); p.className='muted'; p.textContent='No image returned. Try rephrasing to explicitly ask for an image.'; $('#imgOut').appendChild(p);
        }
      }
      $('#imgProgress').hidden = true; $('#imgProgress span').style.width = '0%';
      addToHistory('image', { model, prompt });
    } catch(e){ console.error(e); alert('Image error: '+(e?.message||e)); $('#imgProgress').hidden = true; }
  };

  // ----- Video (Veo) -----
  $('#genVideo').onclick = async () => {
    try{
      if (!ai) return alert('Connect your API key first');
      const model = $('#veoModel').value;
      const prompt = $('#vidPrompt').value.trim();
      if (!prompt) return;
      $('#vidOut').innerHTML = '';
      $('#vidProgress').hidden=false; $('#vidProgress span').style.width='10%';
      const t0 = performance.now();

      let operation = await ai.models.generateVideos({
        model,
        prompt,
        config: { aspectRatio: $('#veoAR').value }
      });

      // Poll until done
      let pct = 15;
      while (!operation.done){
        await new Promise(r=>setTimeout(r, 5000));
        operation = await ai.operations.getVideosOperation({ operation });
        pct = Math.min(95, pct+5); $('#vidProgress span').style.width = pct+'%';
      }

      const t1 = performance.now(); setLatency($('#vidLatency'), t1-t0);
      $('#vidProgress span').style.width = '100%';

      // Try to download: prefer URI if available (browser‑friendly)
      let fileObj = operation.response?.generatedVideos?.[0]?.video;
      let uri = fileObj?.uri || operation.response?.generateVideoResponse?.generatedSamples?.[0]?.video?.uri;
      let blob;
      if (uri){
        const res = await fetch(uri, { headers: { 'x-goog-api-key': apiKey } });
        blob = await res.blob();
      } else if (fileObj?.videoBytes){
        blob = new Blob([new Uint8Array(fileObj.videoBytes)], { type: fileObj.mimeType||'video/mp4' });
      } else {
        // Fallback using files.download may not work in browser; attempt anyway
        try { const dl = await ai.files.download({ file: fileObj }); blob = new Blob([dl.fileBytes], { type: dl.mimeType||'video/mp4' }); } catch {}
      }

      if (!blob) throw new Error('Could not retrieve video bytes');

      const url = URL.createObjectURL(blob);
      const el = document.createElement('div');
      el.innerHTML = `<video controls src="${url}"></video>
        <div class="footer small"><a class="btn" href="${url}" download="veo.mp4">Download video</a>
        <span class="tag">Model: ${model}</span><span class="tag">AR: ${$('#veoAR').value}</span></div>`;
      $('#vidOut').appendChild(el);

      $('#vidProgress').hidden=true; $('#vidProgress span').style.width='0%';
      addToHistory('video', { model, prompt });
    } catch(e){ console.error(e); alert('Video error: '+(e?.message||e)); $('#vidProgress').hidden=true; }
  };
</script>
</body>
</html>
